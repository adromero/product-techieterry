---
// PostCard component - Displays a post preview card for index pages
// Shows title (linked), formatted date, excerpt, decade tag, and StallmanBadge when applicable

import type { CollectionEntry } from 'astro:content';
import StallmanBadge from './StallmanBadge.astro';

interface Props {
  post: CollectionEntry<'posts'>;
}

const { post } = Astro.props;
const { title, date, decade, stallmanAside } = post.data;

// Format date in human-readable format (e.g., "March 15th, 1984")
const formattedDate = date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Generate excerpt from rendered content body (first 150 characters)
const { Content, remarkPluginFrontmatter } = await post.render();
const rawContent = post.body || '';
// Strip markdown syntax and get first 150 chars
const plainText = rawContent
  .replace(/^---[\s\S]*?---\n*/m, '') // Remove frontmatter if present
  .replace(/#{1,6}\s/g, '')           // Remove headers
  .replace(/\*\*|__/g, '')            // Remove bold
  .replace(/\*|_/g, '')               // Remove italic
  .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // Convert links to text
  .replace(/!\[([^\]]*)\]\([^)]+\)/g, '') // Remove images
  .replace(/`{1,3}[^`]*`{1,3}/g, '')  // Remove code
  .replace(/\n+/g, ' ')               // Replace newlines with spaces
  .trim();
const excerpt = plainText.length > 150
  ? plainText.substring(0, 150).trim() + '...'
  : plainText;

// Generate post URL
const postUrl = `/posts/${post.slug}/`;
---

<article class="post-card bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
  <header class="mb-3">
    <div class="flex items-center gap-2 mb-2 flex-wrap">
      <span class="decade-tag text-xs font-sans font-semibold uppercase tracking-wide text-secondary bg-secondary/10 px-2 py-1 rounded">
        {decade}
      </span>
      {stallmanAside && <StallmanBadge size="sm" showLabel={true} />}
    </div>
    <h3 class="font-serif text-xl text-text leading-tight">
      <a
        href={postUrl}
        class="hover:text-primary transition-colors"
      >
        {title}
      </a>
    </h3>
  </header>

  <time
    datetime={date.toISOString()}
    class="block text-sm text-gray-500 font-sans mb-3"
  >
    {formattedDate}
  </time>

  <p class="text-text/80 font-serif text-base leading-relaxed">
    {excerpt}
  </p>

  <footer class="mt-4">
    <a
      href={postUrl}
      class="text-primary font-sans text-sm font-medium hover:underline"
    >
      Read more &rarr;
    </a>
  </footer>
</article>

<style>
  .post-card {
    /* Ensure consistent card appearance */
  }

  .decade-tag {
    /* Additional styling for decade tags if needed */
  }
</style>
